<!DOCTYPE html>

<html>

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    <script src="calculations.js"></script>
    
    <title>BAC Calculator</title>
</head>

<body>
    <div class="container">
        <h1>BAC Calculator</h1>
        <form>
            <div class="mb-3">
                <label for="" class="form-label">Weight (lbs)</label>
                <input type="text" class="form-control" name="weight" id="weight" aria-describedby="helpId"
                    placeholder="">
            </div>
            <div class="mb-3">
                <label for="" class="form-label">Gender</label>
                <select id="gender" class="form-select">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="" class="form-label">Drink size (oz)</label>
                <input type="number" class="form-control" name="size" id="size" aria-describedby="helpId" placeholder="" step="0.1" value="1.5">
            </div>
            <div class="mb-3">
                <label for="" class="form-label">Alcohol % (ABV)</label>
                <input type="number" class="form-control" name="abv" id="abv" aria-describedby="helpId" placeholder="" step="0.1" value="40">
            </div>
            <button type="button" class="btn btn-success" id="add">Add Drink</button>
            <button id="calculate" type="button" class="btn btn-primary">Calculate</button>
        </form>

        <h3>Current BAC: <span id="bac-label">N/A</span></h3>
        <h3>Sober(ish) Time: <span id="sober-label">N/A</span></h3>
        <p style="font-style: italic;">(Sober time is when your BAC drops to 0.05 or below)</p>

        <table class="table">
            <thead><th>Time</th><th>Amount</th><th>BAC</th><th>Actions</th></thead>
            <tbody id="drinks">
            </tbody>
        </table>
        
    </div>
    <script type="text/javascript" >
        var dude = null;
        function DisplayBAC() {
            if (dude != null){
                $("#bac-label").text(dude.get_bac().toFixed(4));
                if (dude.get_bac() > .08) {
                    $("#bac-label").css("color", "red");
                } else {
                    $("#bac-label").css("color", "black");
                }
                let soberTs = dude.sober_time();
                $("#sober-label").text(new Date(soberTs).toLocaleString());
            }
        }
        window.onload = ()=>{
            console.log("doin shit")
            load_session();
            // prune old drinks on load
            prune_old_drinks();
            $("#add").click(()=>{
                if (dude == null) {
                    dude = new Drinker(Number($("#weight").val()), $("#gender").val(), "drink");
                }
                // compute grams of alcohol from size (oz) and ABV (%)
                let sizeOz = Number($("#size").val()) || 1.5;
                let abv = Number($("#abv").val()) || 40;
                // oz -> mL: 1 fl oz = 29.5735 mL; ethanol density = 0.789 g/mL
                let grams = sizeOz * 29.5735 * (abv/100) * 0.789;
                dude.add_drink_now(grams, `${sizeOz}oz @ ${abv}%`);
                // remove any drinks older than 24 hours, then save session
                prune_old_drinks();
                do_table();
                DisplayBAC();
                save_session();
            });
            setInterval(()=>{
                DisplayBAC();
            }, 10000)
        };


        function do_table() {
            $("#drinks").html("");
            for (let i=0; i<dude.drinks.length; i++) {
                const drink = dude.drinks[i];
                const time = new Date(drink.time).toLocaleString();
                const amount = `${drink.name} (${drink.alcohol.toFixed(1)} g)`;
                // `bac` array has an initial element at index 0 representing baseline, so per-drink bac is at i+1
                const bacVal = (dude.bac[i+1] && dude.bac[i+1].bac) ? dude.bac[i+1].bac.toFixed(3) : '';
                $("#drinks").append(`<tr data-index="${i}"><td>${time}</td><td>${amount}</td><td>${bacVal}</td><td><button class="btn btn-sm btn-secondary edit" data-index="${i}">Edit</button> <button class="btn btn-sm btn-danger remove" data-index="${i}">Remove</button></td></tr>`);
            }

            // attach handlers for edit/remove
            $(".remove").click(function(){
                const i = Number($(this).attr('data-index'));
                if (!isNaN(i)) {
                    dude.drinks.splice(i, 1);
                    dude.recompute_bac();
                    do_table();
                    $("#bac-label").text(dude.get_bac());
                    save_session();
                }
            });

            $(".edit").click(function(){
                const i = Number($(this).attr('data-index'));
                if (!isNaN(i)) {
                    show_edit_row(i);
                }
            });
        }

        function toDatetimeLocal(ms) {
            const d = new Date(Number(ms));
            const pad = n => n.toString().padStart(2, '0');
            const yyyy = d.getFullYear();
            const mm = pad(d.getMonth()+1);
            const dd = pad(d.getDate());
            const hh = pad(d.getHours());
            const min = pad(d.getMinutes());
            return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
        }

        function show_edit_row(i) {
            const drink = dude.drinks[i];
            const timeVal = toDatetimeLocal(drink.time);
            const alcoholVal = drink.alcohol.toFixed(2);
            const nameVal = drink.name;
            const $row = $(`#drinks tr[data-index='${i}']`);
            $row.html(`
                <td><input class="form-control form-control-sm" type="datetime-local" id="time-${i}" value="${timeVal}"></td>
                <td>
                    <div class="mb-1"><input class="form-control form-control-sm" id="alcohol-${i}" type="number" step="0.1" value="${alcoholVal}"></div>
                    <div><input class="form-control form-control-sm" id="name-${i}" type="text" value="${nameVal}"></div>
                </td>
                <td></td>
                <td>
                    <button class="btn btn-sm btn-primary save" data-index="${i}">Save</button>
                    <button class="btn btn-sm btn-light cancel" data-index="${i}">Cancel</button>
                </td>
            `);

            $row.find('.cancel').click(()=>{ do_table(); });
            $row.find('.save').click(()=>{ save_edit_row(i); });
        }

        function save_edit_row(i) {
            const t = $(`#time-${i}`).val();
            const a = Number($(`#alcohol-${i}`).val()) || 0;
            const n = $(`#name-${i}`).val() || '';
            const ts = new Date(t).getTime();
            if (!isNaN(ts)) {
                dude.drinks[i].time = ts;
            }
            dude.drinks[i].alcohol = a;
            dude.drinks[i].name = n;
            dude.recompute_bac();
            do_table();
            $("#bac-label").text(dude.get_bac());
            save_session();
        }

        // Session cookie helpers - store weight, gender, and drinks array in a session cookie
        function save_session() {
            if (dude == null) return;
            const payload = {
                weight: dude.weight,
                gender: (dude.r == 0.68) ? 'male' : 'female',
                drinks: dude.drinks.map(d => ({alcohol: d.alcohol, time: d.time, name: d.name}))
            };
            const val = encodeURIComponent(JSON.stringify(payload));
            document.cookie = `fuzzy_drink_meter=${val}; path=/`;
        }

        function get_cookie(name) {
            const cookies = document.cookie.split(';').map(c => c.trim());
            for (const c of cookies) {
                if (c.startsWith(name + '=')) {
                    return c.substring((name + '=').length);
                }
            }
            return null;
        }

        function load_session() {
            const raw = get_cookie('fuzzy_drink_meter');
            if (!raw) return;
            try {
                const data = JSON.parse(decodeURIComponent(raw));
                if (!data) return;
                const w = Number(data.weight) || Number($("#weight").val()) || 0;
                const g = data.gender || $("#gender").val() || 'male';
                dude = new Drinker(w, g);
                if (Array.isArray(data.drinks)) {
                    for (const d of data.drinks) {
                        // ensure time is a number
                        const t = Number(d.time) || Date.now();
                        dude.add_drink(Number(d.alcohol) || 0, t, d.name || 'drink');
                    }
                }
                dude.recompute_bac();
                do_table();
                DisplayBAC();
            } catch (e) {
                console.error('failed to load session cookie', e);
            }
        }

        // remove drinks older than 24 hours (86400000 ms)
        function prune_old_drinks() {
            if (dude == null) return;
            const cutoff = Date.now() - 24 * 3600000;
            const before = dude.drinks.length;
            dude.drinks = dude.drinks.filter(d => (Number(d.time) >= cutoff));
            if (dude.drinks.length !== before) {
                dude.recompute_bac();
                do_table();
                DisplayBAC();
                save_session();
            }
        }
    </script>
</body>

</html>